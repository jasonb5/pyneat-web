{% extends "base.html" %}

{% block breadcrumbs %}
{% with pop=org.population %}
<li>
  <a href="{% url 'experiment' pop.experiment.pk %}">Experiment {{ pop.experiment.pk }}</a>
</li>
<li>
  <a href="{% url 'population' pop.pk %}">Population {{ pop.rel_index }}</a>
</li>
{% endwith %}
<li>
  <a href="{% url 'generation' org.generation.pk %}">Generation {{ org.generation.rel_index }}</a>
</li>
<li>
  <a href="{% url 'species' org.species.pk %}">Species {{ org.species.rel_index }}</a>
</li>
<li class="active">
  <a href="{% url 'organism' org.pk %}">Organism {{ org.rel_index }}</a>
</li>
{% endblock %}

{% block content %}
<div class="column-group gutters">
  <div class="all-25">
    <table id="org-table" class="ink-table bordered">
    {% for k, v in fields.items %}
      <tr>
        <td>{{ k }}</td>
      {% if k == 'fitness' %}
        <td>{{ v|floatformat:2 }}</td>
      {% else %}
        <td>{{ v }}</td>
      {% endif %}
      </tr>
    {% endfor %}
    </table>
  </div>
  <div class="all-75">
    <div id="network"></div>
  </div>
</div>

<style charset="utf-8">
circle {
  fill: #ccc;
  stroke: #333;
  stroke-width: 1.5px;
}

.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}
</style>

<script type="text/javascript">
var nodes = [];
var links = [];

{% for node in neurons %}
nodes.push({ name: {{ node }} });
{% endfor %}

{% for gene in genes %}
links.push({ source: {{ gene.inode }}, target: {{ gene.onode }} });
{% endfor %}

var width = 600,
    height = 400;

var force = d3.layout.force()
  .nodes(nodes)
  .links(links)
  .size([width, height])
  .charge(-400)
  .linkDistance(40)
  .on('tick', tick)
  .start();

var svg = d3.select('#network').append('svg')
  .attr('width', width)
  .attr('height', height);

svg.append('defs').selectAll('marker')
  .data(['to',])
  .enter().append('marker')
  .attr('id', function(d) { return d; })
  .attr('viewBox', '0 -5 10 10')
  .attr('refX', 15)
  .attr('refY', -1.5)
  .attr('markerWidth', 6)
  .attr('markerHeight', 6)
  .attr('orient', 'auto')
  .append('path')
  .attr('d', 'M0,-5L10,0L0,5');

var path = svg.append('g').selectAll('path')
  .data(force.links())
  .enter().append('path')
  .attr('class', function(d) { return 'link'; })
  .attr('marker-end', function(d) { return 'url(#to)'; });

var circle = svg.append('g').selectAll('circle')
  .data(force.nodes())
  .enter().append('circle')
  .attr('r', 6)
  .call(force.drag);

function tick() {
  path.attr('d', link);
  circle.attr('transform', transform);
}

function link(d) {
  return 'M' + d.source.x + ',' + d.source.y + 'L' + d.target.x + ',' + d.target.y;
}

function transform(d) {
  return 'translate(' + d.x + ',' + d.y + ')';
}
</script>

{% endblock %}
